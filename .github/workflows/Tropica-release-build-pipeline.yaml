name: Tropica Development Release Build

on:
  push: 
    branches: [ development ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Debug secret existsd
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "Secret is EMPTY";
          else
            echo "Secret FOUND (not printing)";
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Test Build
        run: npm run build
  
  build:
    runs-on: ubuntu-latest
    environment: development # specific to development build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Create .env file
        run: |
          echo "TOKEN='${{ secrets.BOT_TOKEN }}'" >> .env
          echo "MONGODB_URI='${{ secrets.DatabaseUri }}'" >> .env
          echo "CLIENT_ID='${{ secrets.BOT_CLIENTID }}'" >> .env
          echo "STATUS='${{ secrets.BOT_STATUS }}'" >> .env
          echo "BOT_STATUS_URL='${{ secrets.BETTERSTACK_BOT }}'" >> .env
          echo "DB_STATUS_URL='${{ secrets.BETTERSTACK_DB }}'" >> .env

      - name: Run Test Build
        run: npm run build

      - name: Notify Discord (starting deployment)
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"ðŸš€ Deployment started on GitHub Actions.\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Test SSH conn
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER}}@${{ secrets.SSH_HOST }} "cd ${{ secrets.TARGET_DIR }} && echo SSH OK"
          
      - name: Upload files via rsync
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" rsync -avz --delete \
          --exclude=".git" \
          --exclude="node_modules" \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}
          
      - name: Install Dependencies in folder
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.TARGET_DIR }}/dist &&
            npm ci --production &&
            pm2 restart tropica-ts-beta || pm2 start index.js --name tropica-ts-beta
            "
  
      # - name: Setup SSH key
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy.key
      #     chmod 600 ~/.ssh/deploy.key

      # - name: Test SSH connectivity
      #   run: |
      #     ssh -i ~/.ssh/deploy.key -p 22 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo connected"

      # - name: Upload build files
      #   run: |
      #    rsync -avz -e "ssh -i ~/.ssh/deploy.key -p 22 -o StrictHostKeyChecking=no" \
      #     dist/ \
      #     .env \
      #     package.json \
      #     package-lock.json \
      #     ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/ubuntu/Tropica-TS-Beta/new/














