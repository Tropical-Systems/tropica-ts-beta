name: Deploy Tropica Beta Build

on: 
  workflow_run:
    workflows: [ Tropica Development Release Build ]
    types: [ completed ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Download build artifact
        uses: actions/github-script@v7
        with:
          script: |
            // Get owner and repo
            const repoInfo = context.repo;
            const owner = repoInfo.owner;
            const repo = repoInfo.repo;

            // Get workflow run ID
            const runId = context.payload.workflow_run.id;

            // List artifacts for this workflow run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId
            });

            const match = artifacts.data.artifacts.find(a => a.name === "ts-build");
            if (!match) throw new Error("Artifact not found");

            // Download artifact
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: match.id,
              archive_format: 'zip'
            });

            require('fs').writeFileSync('artifact.zip', Buffer.from(download.data));

      - name: Extract Artifact
        run: unzip artifact.zip -d artifact

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy.key
          chmod 600 ~/.ssh/deploy.key

      - name: Upload build to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy.key -o StrictHostKeyChecking=no" \
            ./artifact/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/ubuntu/Tropica-TS-Beta/new/

      # - name: Deploy on OVH server
      #   run: |
      #     ssh -i ~/.ssh/deploy.key -o StrictHostKeyChecking=no \
      #       ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            
      #       cd /home/ubuntu/Tropica-TS

      #       echo "Stopping PM2 process..."
      #       pm2 stop tropica-backend || true

      #       echo "Removing old build and package files..."
      #       rm -rf dist
      #       rm -f package.json
      #       rm -f package-lock.json

      #       echo "Moving new files into place..."
      #       mv new/dist ./dist
      #       mv new/package.json .
      #       mv new/package-lock.json .
      #       mv new/.env .
      #       rm -rf new

      #       echo "Installing production dependencies..."
      #       npm ci --omit=dev

      #       echo "Starting PM2 process..."
      #       pm2 start dist/index.js --name tropica-backend
      #       pm2 save

      #     EOF

            
